# 虚拟机游戏自动化方案

## 📖 简介

这个方案允许你在**虚拟机**中运行游戏，在**主机**中运行自动化脚本并控制虚拟机中的游戏。

## 🏗️ 架构

```
主机                    虚拟机
│                      │
│  ┌─────────────────┐ │  ┌──────────────┐
│  │  GUI 控制台      │─┼─▶│ 游戏程序     │
│  ├─────────────────┤ │  └──────────────┘
│  │  AI 检测        │ │  ┌──────────────┐
│  │  (YOLO)         │ │─▶│ 代理服务器   │
│  ├─────────────────┤ │  │ (WebSocket)  │
│  │  远程客户端      │─┼─┴──────────────┘
│  └─────────────────┘ │
│                      │
└──────────────────────┘
```

## 🚀 快速开始

### 步骤 1：配置虚拟机网络

确保虚拟机网络配置为 **桥接模式** 或 **NAT 模式**（带端口转发）：

**桥接模式（推荐）：**
- 虚拟机直接连接到物理网络
- 虚拟机获得独立 IP 地址（如 192.168.1.100）

**NAT 模式（端口转发）：**
- 主机端口 8765 → 虚拟机端口 8765

### 步骤 2：获取虚拟机 IP

在虚拟机中运行：

**Windows 虚拟机：**
```cmd
ipconfig
```

**Linux 虚拟机：**
```bash
ip addr show
```

记下虚拟机的 IP 地址（例如：`192.168.1.100`）

### 步骤 3：在虚拟机中启动代理服务器

将整个项目复制到虚拟机中，然后在虚拟机中运行：

```bash
cd hjzg-autoplayer/vm_proxy
start_vm_server.bat    # Windows
# 或
python remote_server.py  # 手动启动
```

你会看到：
```
游戏代理服务器启动中...
监听地址: 0.0.0.0:8765
按 Ctrl+C 停止服务器
```

### 步骤 4：在主机中启动远程 GUI

在主机中运行：

```bash
cd hjzg-autoplayer/vm_proxy
start_host_client.bat
# 或
python remote_gui_script.py
```

### 步骤 5：连接虚拟机

1. 在 GUI 界面中，输入虚拟机 IP（例如：`192.168.1.100`）
2. 点击 **"🔌 连接虚拟机"** 按钮
3. 等待连接成功（状态变为绿色的"● 已连接"）

### 步骤 6：测试连接

点击 **"🧪 测试连接"** 按钮：
- 会截取虚拟机屏幕
- 会在虚拟机屏幕中心点击

### 步骤 7：启动自动化

1. 选择一个脚本（如 "副本刷图"）
2. 点击 **"▶ 启动"** 按钮
3. 脚本将自动运行，并在日志区域显示运行状态

## 📁 文件说明

| 文件 | 说明 | 运行位置 |
|------|------|----------|
| `remote_server.py` | 虚拟机代理服务器 | 虚拟机 |
| `remote_client.py` | 主机网络客户端 | 主机 |
| `remote_screen_detector.py` | 远程屏幕检测器 | 主机 |
| `remote_game_input.py` | 远程游戏输入 | 主机 |
| `remote_gui_script.py` | 主机 GUI 控制台 | 主机 |
| `start_vm_server.bat` | 虚拟机启动脚本 | 虚拟机 |
| `start_host_client.bat` | 主机启动脚本 | 主机 |
| `config.json` | 配置文件 | 两者 |

## 🔧 依赖安装

### 虚拟机端（Windows）

```cmd
pip install websockets numpy opencv-python pillow pyautogui
```

### 主机端（Windows/Linux）

```bash
pip install websockets numpy opencv-python pillow
```

## ⚙️ 配置说明

### 网络配置

**防火墙设置（虚拟机）：**
- Windows 防火墙：允许端口 8765 入站
- Linux 防火墙：
  ```bash
  sudo ufw allow 8765
  ```

### 性能优化

**降低截图延迟：**
- 降低 JPEG 质量（`config.json` 中的 `quality` 参数）
- 使用有线网络而非 Wi-Fi
- 确保虚拟机有足够的 CPU/内存资源

**调整超时时间：**
在 `remote_client.py` 中修改：
```python
self.timeout = 5.0  # 增加超时时间
```

## 🐛 故障排查

### 问题 1：无法连接虚拟机

**检查：**
1. 虚拟机代理服务器是否正在运行？
2. IP 地址是否正确？
3. 防火墙是否阻止了端口 8765？
4. 网络是否可达？（使用 `ping` 测试）

**解决：**
```bash
# 在主机上测试连接
telnet 192.168.1.100 8765

# 或使用 PowerShell
Test-NetConnection -ComputerName 192.168.1.100 -Port 8765
```

### 问题 2：截图延迟过高

**原因：** 网络传输延迟 + JPEG 编码/解码

**解决：**
1. 降低截图质量
2. 使用有线网络
3. 升级虚拟机网络适配器到 "VirtIO" 或 "VMXNET3"

### 问题 3：点击位置不准确

**原因：** 虚拟机和主机的分辨率不匹配

**解决：**
- 确保虚拟机分辨率固定（如 1920x1080）
- 在 `remote_client.py` 中硬编码屏幕尺寸
- 或添加一个获取虚拟机屏幕尺寸的 API

### 问题 4：YOLO 检测失败

**检查：**
1. 模型文件是否存在？（`hjzgv1.pt`）
2. 截图是否正常？（点击"测试连接"查看）
3. 置信度阈值是否过高？

## 🎯 高级用法

### 自定义端口

修改 `config.json`：
```json
{
  "vm_host": "192.168.1.100",
  "vm_port": 9999,  // 自定义端口
  ...
}
```

### 多虚拟机支持

创建多个配置文件，每个虚拟机一个：

```bash
vm1_config.json
vm2_config.json
vm3_config.json
```

在启动时指定配置文件：
```python
with open('vm1_config.json') as f:
    config = json.load(f)
```

### 后台运行虚拟机服务器

**Windows：**
```cmd
start /B python remote_server.py > server.log 2>&1
```

**Linux：**
```bash
nohup python remote_server.py > server.log 2>&1 &
```

## 🔒 安全建议

1. **仅在受信任网络中使用**
   - 不要将代理服务器暴露到公网
   - 使用虚拟机隔离网络环境

2. **使用防火墙限制访问**
   ```bash
   # 仅允许特定 IP 访问
   sudo ufw allow from 192.168.1.50 to any port 8765
   ```

3. **添加身份验证**（可选）
   - 在 WebSocket 握手中添加 Token
   - 或使用 TLS 加密连接

## 📊 性能参考

| 指标 | 数值 |
|------|------|
| 截图延迟 | 50-200ms (有线) |
| 点击延迟 | 30-100ms |
| 网络带宽 | 2-5 Mbps (1080p, 60fps) |
| CPU 占用（虚拟机） | 5-15% |
| CPU 占用（主机） | 20-40% (YOLO 检测) |

## 📝 开发计划

- [ ] 支持 TLS 加密连接
- [ ] 支持多虚拟机同时控制
- [ ] 添加屏幕录制功能
- [ ] 支持区域截图（减少网络传输）
- [ ] 添加性能监控面板

## 🆘 技术支持

如有问题，请检查：
1. 日志输出中的错误信息
2. 虚拟机和主机的网络连接
3. 防火墙和安全软件设置
4. 项目 GitHub Issues

---

**注意：** 使用自动化脚本可能违反游戏服务条款，仅供学习和研究使用。
